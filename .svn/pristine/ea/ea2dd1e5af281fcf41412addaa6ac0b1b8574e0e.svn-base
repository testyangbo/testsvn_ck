import { test, expect } from '@playwright/test';
import { testConfig } from '../../config/testConfig';
import { PurchaseOrderPage } from '../../pages/purchaseOrder.page';
import { setupTestEnvironment } from '../../pages/testUtils';
import { TEST_DATA } from '../../data/testData';
import { TEST_Menu } from '../../data/testmenu';
import { OpenTheMenuPage } from '../../pages/openTheMenu.page';


// 在测试配置中添加
//test.use({ storageState: 'cookies/auth.json' });
// 复用登录状态


test.describe('采购订单', () => {

  let context;
  let page;
  let purchaseOrderPage;
  let openTheMenuPage;
  // 所有用例开始前执行
  test.beforeAll(async ({ browser }) => {
    const result = await setupTestEnvironment(browser);
    //const context = result.context;
    const page = result.page;
    purchaseOrderPage = new PurchaseOrderPage(page);
    openTheMenuPage = new OpenTheMenuPage(page);
  });

  // 每个用例执行前执行
  test.beforeEach(async () => {

        await openTheMenuPage.openMenu(TEST_Menu.Purchase, TEST_Menu.purchaseOrder);

  });

  // 第一条用例
  test('采购订单正常保存', async ({}) => {
    await purchaseOrderPage.setAddSupplierCell();   // 打开供应商界面
    await purchaseOrderPage.selectSupplier();   // 选择供应商
    await purchaseOrderPage.setDeliveryDate();  // 设置交货日期
    await purchaseOrderPage.selectProduct(TEST_DATA.product);    // 选择商品
    await purchaseOrderPage.setQuantity(5);      // 设置数量
    await purchaseOrderPage.setUnitPrice(100);     // 设置单价
    await purchaseOrderPage.setAmount(500);        // 设置金额
    await purchaseOrderPage.saveOrder();        // 保存订单
    await expect(purchaseOrderPage.messageContent).toHaveText('采购订单，保存审核成功！');
    // 等待messageContent消失
    await purchaseOrderPage.messageContent.waitFor({ state: 'hidden', timeout: 5000 });  

  });
  
  // 第二条用例
test('打开单据录入商品后删除商品', async ({}) => {
  await purchaseOrderPage.setAddSupplierCell(); // 打开供应商界面
  await purchaseOrderPage.selectSupplier();
  await purchaseOrderPage.setDeliveryDate();
  await purchaseOrderPage.selectProduct(TEST_DATA.product); // 录入商品
  await purchaseOrderPage.clickDeleteRow(); // 删除商品行
  await expect(purchaseOrderPage.deleteRowButton).not.toBeVisible(); // 断言删除按钮不存在
  console.log('已完成打开单据、录入商品并删除商品的操作流程');
  await purchaseOrderPage.selectProduct(TEST_DATA.product); // 录入商品
  await purchaseOrderPage.setModifyButton(); // 删除商品按钮
  await expect(purchaseOrderPage.modifyButton).not.toBeVisible(); // 断言删除按钮不存在
  
})

  // 第三条用例 - 验证必录项目控制
test('验证必录项目控制', async ({}) => {
  // 不选择供应商，尝试保存订单，应该失败
  await purchaseOrderPage.saveOrder();         // 尝试保存订单
  await expect(purchaseOrderPage.messageContent).toHaveText('供应商不能为空!');
  // 等待messageContent消失
  await purchaseOrderPage.messageContent.waitFor({ state: 'hidden', timeout: 5000 });
  
  
  // 重新选择供应商，但不选择商品，尝试保存订单，应该失败
  await purchaseOrderPage.setAddSupplierCell(); // 打开供应商界面
  await purchaseOrderPage.selectSupplier();   // 选择供应商
  await purchaseOrderPage.saveOrder();         // 尝试保存订单
  await expect(purchaseOrderPage.messageContent).toHaveText('数据不能为空!');
  // 等待messageContent消失
  await purchaseOrderPage.messageContent.waitFor({ state: 'hidden', timeout: 5000 });
  

  // 不设置数量
    await purchaseOrderPage.selectProduct(TEST_DATA.product);    // 选择商品
  await purchaseOrderPage.setUnitPrice(100);   // 设置单价
  await purchaseOrderPage.saveOrder();         // 尝试保存订单
  await expect(purchaseOrderPage.messageContent).toHaveText('表格第1行，请填写数量!');
  // 等待messageContent消失
  await purchaseOrderPage.messageContent.waitFor({ state: 'hidden', timeout: 5000 });
  
  
  // 选择供应商和商品，设置数量，但不设置单价，尝试保存订单，应该失败
  await purchaseOrderPage.setQuantity(5);      // 设置数量
  await purchaseOrderPage.setUnitPrice(0);   // 设置单价
  await purchaseOrderPage.saveOrder();         // 尝试保存订单
  await expect(purchaseOrderPage.messageContent).toHaveText('表格第1行，请填写单价!');
  // 等待messageContent消失
  await purchaseOrderPage.messageContent.waitFor({ state: 'hidden', timeout: 5000 });

})
  
    // 采购订单纯草稿用例
  test('采购订单存草稿调单保存', async ({}) => {
    console.log('采购订单存草稿调单保存开始');
    await purchaseOrderPage.setAddSupplierCell();   // 打开供应商界面
    await purchaseOrderPage.selectSupplier();   // 选择供应商
    await purchaseOrderPage.setDeliveryDate();  // 设置交货日期
    await purchaseOrderPage.selectProduct(TEST_DATA.product);    // 选择商品
    await purchaseOrderPage.setQuantity(5);      // 设置数量
    await purchaseOrderPage.setUnitPrice(100);     // 设置单价
    await purchaseOrderPage.setAmount(500);        // 设置金额
    await purchaseOrderPage.saveOrderDraft();        // 保存草稿
    await expect(purchaseOrderPage.messageContent).toHaveText('存草稿成功！'); 
    // 等待messageContent消失
    await purchaseOrderPage.messageContent.waitFor({ state: 'hidden', timeout: 5000 });     // 执行查询
    await purchaseOrderPage.clickQueryButton();

    await purchaseOrderPage.handleDialogMessage('saveDraft');
    
  });


  // 分页和查询功能测试用例
  test('分页和查询功能测试', async ({}) => {
    // 操作首页
    await purchaseOrderPage.clickHomepage();
    await purchaseOrderPage.handleDialogMessage('saveDraft');
    // 操作上一页
    await purchaseOrderPage.clickLastPage();
    await purchaseOrderPage.handleDialogMessage('saveDraft');
    // 操作下一页
    await purchaseOrderPage.clickNextPage();
    await purchaseOrderPage.handleDialogMessage('saveDraft');
    // 操作末页
    await purchaseOrderPage.clickLastPageButton(); 
    await purchaseOrderPage.handleDialogMessage('cancelReduction');
    console.log('已完成分页和查询功能测试');
  });



  // 每个用例执行后执行
  test.afterEach(async () => {
    await purchaseOrderPage.closeOrder();
    await purchaseOrderPage.handleDialogMessage1('saveDraftAndContinue');
  });

  // 所有用例结束后执行
  test.afterAll(async () => {
    // 关闭浏览器上下文
    try {
      if (page && page.close) {
        await page.close();
        console.log('页面已关闭');
      }
      if (context && context.close) {
        await context.close();
        console.log('浏览器上下文已关闭');
      }
    } catch (error) {
      console.error('关闭浏览器上下文时出错:', error.message);
    }
  });

});
